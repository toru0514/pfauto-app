# Creema & Minne Automation App

このドキュメントは、本プロジェクトに関する方針・要件・設計指針のマスタとして管理します。更新時は必ず内容を確認し、このREADMEを基準に議論・作業を進めてください。

## プロジェクト概要
- **目的**: Creema・minneをはじめとしたハンドメイド作品販売プラットフォームへの出品作業を自動化し、スプレッドシートに蓄積した商品情報を元に各PFの下書き状態まで生成する。
- **ターゲットPF**: 初期対応はCreemaとminne。将来的にBASEなど他PFへ拡張可能なアーキテクチャを採用する。
- **利用技術**: フロントエンドはNext.js + Tailwind CSS + shadcn/ui、バックエンド/APIはNext.js内で構築。自動化処理にPlaywrightを利用し、Vercelへデプロイする。

## ユースケース
- 商品情報をスプレッドシートで一元管理し、対象PFに応じた下書きを自動生成。
- 投稿前の状態まで自動操作し、ユーザーが最終確認・微調整のうえ手動で公開する運用。
- 複数PFへの同時出品を効率化し、ヒューマンエラーを削減。

## 主要機能
- Google Sheetsからの商品データ取得・同期（差分検知、ステータス更新）。
- PFごとの入力項目マッピングとバリデーション。
- Playwrightによるログイン・フォーム入力処理の自動化（画像対応は後続検討）。
- 実行ステータスの可視化ダッシュボード（実行キュー、エラーログ、リトライ制御）。
- 新規PF追加や項目変更に対応しやすいアダプタ構造。

## スコープ
- **対象外**: 自動での最終投稿操作、PF側の承認・公開ワークフロー制御、在庫管理機能。
- **前提**: ユーザーはPFの利用規約・自動化に関する制約を順守し、必要に応じて2段階認証等の設定を行う。
- **スコープ外対応**: 大量投稿・大規模バッチ処理は現段階では考慮しない。

## アーキテクチャ方針
- **Next.js App Router** を前提とし、サーバーアクションやAPI Routesを組み合わせて実装。
- **shadcn/ui + Tailwind CSS** で管理画面を構築し、フォームやテーブルなど再利用性の高いUIコンポーネントを活用。
- **Playwright** はバックエンド側で操作し、ブラウザ自動操作ジョブはサーバーサイドでトリガー。
- データ保存は当面Next.jsのサーバー環境上（Vercel）で扱いやすいマネージドDB（Supabase/Postgres）もしくはVercel KVを検討。
- PFごとの実装は抽象化された`PlatformAdapter`インターフェースに従い、入力項目・操作フローを分離。

## 想定データモデル（初期案）
- `Product`: スプレッドシートと同期する商品情報。タイトル、説明、価格、タグ、画像参照先のメタ情報、PF別の出品ステータスを保持。
- `SubmissionJob`: 実行された自動投稿ジョブの履歴。対象PF、開始・終了時刻、結果、エラー内容など。
- `PlatformConfig`: PF固有の入力マッピング・必須項目・バリデーションルール。

## 外部連携
- **Google Sheets API**: 認証はService Accountを利用し、指定スプレッドシートの読み書きを行う。
- **画像ストレージ**: 初期フェーズではローカルもしくは既存の管理フローを前提にし、後続でmicroCMS等を検討。
- **認証情報管理**: Vercelの環境変数およびSecret Managementを活用。Playwrightで必要なCookieやトークンの扱いは暗号化ストレージで管理する方針。

## セキュリティ・運用上の考慮
- PFの利用規約に抵触しない範囲での自動化設計（アップロード操作を行わない範囲で、自身のアカウント内の操作やスクレイピングは問題ないことを確認済み）。
- 2段階認証やCAPTCHA発生時の手動介入手段を提供。
- ログイン情報・APIキーはGit管理から除外し、ローテーション可能な仕組みを用意。
- ジョブ失敗時のリトライ制御と通知（メール/Slackなど）を検討。

## 開発ロードマップ（ドラフト）
1. 要件すり合わせ & スプレッドシート項目定義
2. Next.jsプロジェクトセットアップ（Tailwind、shadcn/ui導入、認証/環境変数のベース整備）
3. Google Sheets API連携PoC（読み込み・ステータス更新）
4. PlaywrightでのCreemaログイン・フォーム自動入力PoC
5. minne対応、フォーム入力モジュール共通化
6. UIダッシュボード構築（商品一覧、ジョブ履歴、実行トリガー）
7. エラー処理・リトライ・通知フロー実装
8. BASEなど追加PFの検討とアダプタ設計見直し

## Playwright自動入力に向けた準備事項
- **検証環境**: Creema / minne のテスト用アカウント（本番と同等のフローが確認できるもの）。
- **ログイン情報管理**: メールアドレス・パスワード、2段階認証コード取得手段（Authenticator／メールなど）。
- **ターゲットページの調査**: ログインページ、商品登録フォーム、下書き保存ページのURLと遷移フロー。
- **フォーム項目一覧**: 各PFで必須・任意の入力フィールド、文字数制限、選択肢の有無、画像仕様。
- **DOMセレクタ設計**: 安定したCSSセレクタ／テストIDの抽出。変更が頻繁な要素はラッパー関数で抽象化。
- **ステップ定義**: ログイン、商品情報入力、画像仮アップロード、下書き保存直前までの操作シーケンス。
- **エラー検出ポイント**: バリデーションエラー表示、タイムアウト、CAPTCHA などの分岐処理把握。
- **手動介入手段**: ヘッドフル実行で途中停止できるデバッグモード、失敗時のスクリーンショット保存。

## テスト・検証方針
- PlaywrightテストでPFフォーム操作のスモークテストを定期実行。
- Next.js APIはユニットテスト（Jest/Testing Library）とエンドツーエンドテストを組み合わせる。
- スプレッドシート同期処理のモックテストやステージング環境での結合確認を実施。

## デプロイ・環境
- **ホスティング**: Vercel（Production / Preview環境を活用）。
- **CI/CD**: GitHub連携による自動デプロイ、PlaywrightテストのCI実行。
- **環境変数管理**: VercelのEnvironment VariablesとSecret Storeを使用。

## 今後の検討事項
- 画像管理フローの再整理（microCMS導入タイミング、サイズ圧縮、カテゴリ整理など）。
- 手動介入を支援するUI改善（差分比較、プレビュー画面、チェックリスト）。
- 法令対応（特商法、個人情報保護）やコンプライアンス確認プロセス。

---
このREADMEが常に最新の仕様・方針を反映するよう、変更時は内容をレビューしてから反映してください。
